{% extends 'anime/base.html' %}

{% block style %}
	#more {display: none;}

	dl, ol, ul {
	    margin-top: 0;
	    margin-bottom: 0;
	}
	.breadcrumb {
		margin-bottom: 0;
		background-color: inherit ;
		padding: 0;
	}

	.chap_img {
		width: 40px ;
		height: 55px ;
		margin-right: 15px;
		margin-top: 10px;
		border-radius: 5px;
	}

	a:hover {
	    color: #0056b3;
	    text-decoration: none;
	}

	.hover:hover {
		opacity: 1!important;
		background-color:#EEE;
	}

	#new_option_form {
		width: 100%;
		height: 100%;
		z-index :1000;
		margin-left: 20%;
	}

	#new_option,#new_option_input {
		width: 50%;
		margin-top: 0%;
		margin-left: 14%;
		z-index: 1001;
	}

	/* STAR RATE STYLE */
	* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: arial;
	}

	.star-rating form {
	    display: none;
	}

	.star-rating .thanks-msg {
	    display: none;
	    font-size: 20px;
	    margin: 40px auto;
	    color: #4caf50;
	    background-color: rgba(76, 175, 80, 0.1411764705882353);
	    padding: 8px 20px;
	    border-left: 3px solid #4caf50;
	    border-radius: 20px;
	}

	.star-rating input {
	    display: none;
	}

	.star-rating {
	    margin: 50px 0% 0 0%;
	    display: table;
	    width: 100%;
	    float: left!important;

	}
	.star-rating label {
	    padding: 10px;
	    float: right;
	    font-size: 44px;
	    color: #eee;
	}
	.star-rating input:not(:checked) ~ label:hover,
	.star-rating input:not(:checked) ~ label:hover ~ label {
	    color: #ffc107;
	}
	.star-rating input:checked ~ label {
	    color: #ffc107;
	}
	.star-rating form .rating-reaction:before {
	    width: 100%;
	    float: left;
	    color: #ffc107;
	}
	.star-rating #rating-1:checked ~ form .rating-reaction:before {
	    content: "I hate it";
	}
	.star-rating #rating-2:checked ~ form .rating-reaction:before {
	    content: "I don't like it";
	}
	.star-rating #rating-3:checked ~ form .rating-reaction:before {
	    content: "It is good";
	}
	.star-rating #rating-4:checked ~ form .rating-reaction:before {
	    content: "I like it";
	}
	.star-rating #rating-5:checked ~ form .rating-reaction:before {
	    content: "I love it";
	}
	.star-rating input:checked ~ form {
	    border-top: 1px solid #ddd;
	    width: 100%;
	    padding-top: 15px;
	    margin-top: 15px;
	    display: inline-block;
	}
	.star-rating form .rating-reaction {
	    font-size: 24px;
	    float: left;
	    text-transform: capitalize;
	}
	.star-rating form .submit-rating {
	    border: none;
	    outline: none;
	    background: #795548;
	    color: #ffc107;
	    font-size: 18px;
	    border-radius: 4px;
	    padding: 5px 15px;
	    cursor: pointer;
	    float: right;
	}
	form .submit-rating:hover {
	    background-color: #333;
	}


{% endblock style %}

{% block content %}
<span ></span>
<div id="new_option_form" class="d-none position-absolute ">
</div>
<form id="new_option" name="add_new_list" class="d-none  position-absolute top-50 start-25">
	{% csrf_token %}
	<div class="d-inline">
		<input id="new_option_input" type="text" name="new_option" class="form-control d-inline">
		<button type="submit" class="btn btn-info d-inline">add</button>
	</div>
</form>

<div class="container">
	<div class="card">
	  <div class="card-header">
	    <nav aria-label="breadcrumb">
		  <ol class="breadcrumb">
		    <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
		    <li class="breadcrumb-item"><a href="{% url 'all-manga' %}">Library</a></li>
		    <li class="breadcrumb-item active" aria-current="page">{{ manga.name }}</li>
		  </ol>
		</nav>
	  </div>
	  <div class="card-body">
	  	<div class="row">
	  		<div class="col-md-3">
	  			<img src="/media/poster.webp">
	  			<form class="add_to_list">
	  				{% csrf_token%}
		  			<select id="lista" name="list_name">
		  				{% for list in lists %}
		  					<option id="kkl{{ forloop.counter }}" class="{{forloop.counter}}" value="{{list.name}}">{{list.name}}</option>
		  				{% endfor %}
		  				<div class="modal-dialog modal-lg">
		  					<option id="option_add" class="">add new list</option>
		  				</div>
		  			</select>
		  			<input type="hidden" name="manga_id" value="{{manga.id}}">
		  			<button id='add_list_button' type="submit" class="btn btn-info ">
		  				{% if in_list %}
		        			-
		        		{% else %}
		        			+
		        		{% endif %}
					</button>
	  			</form>
	  		</div>
		  	<div class="col-md-8">
			    <h3 class="card-title">{{manga.name}}</h3>
			    <p class="card-text">{{ manga.description|slice:":250" }} <span id="dots">...</span><span id="more"> {{ manga.description|slice:"250:" }}</span>
			    <a href="#" onclick="myFunction()" id="myBtn">Read more</a>
			    </p>
			    <div class="mb-3">
			    	<h5 class="d-inline">Genres: </h5>
				    {% for g in manga.genres_as_list %}
				        <a href="#" class="btn-info rounded-pill p-1">{{ g }}</a>
				    {% endfor %}
			    </div>
			    <a href="#" class="btn btn-primary">Start Read</a>
			    <form class="add_fav d-inline">
			    	{% csrf_token %}
			    	<input type="hidden" name="manga_id" value="{{manga.id}}">
			    	<button type="submit" class="btn {% if in_fav %}true btn-danger{% else %}False btn-primary{% endif %}">
					        		{% if in_fav %}
					        			Unfollow
					        		{% else %}
					        			Follow
					        		{% endif %}
					        	</button>
			    </form>
		  	</div>
	  	</div>
	  </div>
	</div>
</div>

<div>
	<div class="container">
		<h2 class="mt-3">Chapters</h2>
		<ul class="list-group">
		{% for chapter in chapters %}
			<a href="{% url 'chapter' chapter.manga.name chapter.chapter_number %}" class="mb-2">	
			  <li class="list-group-item d-flex  hover">
			    <img src="/media/poster.webp" class="chap_img">
			    <div>
				    <div class="d-block  fs-3">{{ chapter.manga.name }}</div>
				    <span class="d-block p-1 bg-primary rounded-pill text-white">Chapter {{ chapter.chapter_number }} <span class="bg-danger pr-2 pl-2 rounded-pill text-white">New</span></span>
			    </div>
			  </li>
			  <span></span>
			</a>
			{% endfor %}
		</ul>
	</div>
</div>
<div class="reviews">
	<div class="container">
		<h2>Reviews</h2>
		<div class="star-rating text-left mb-5">
		    <div class="thanks-msg text-left">Thanks for your feedback !!!</div>
		    <div class="star-input float-start">
		        <input type="radio" name="rating" id="rating-5" onclick="setRate(5)">
		        <label for="rating-5" class="fas fa-star"></label>
		        <input type="radio" name="rating" id="rating-4" onclick="setRate(4)">
		        <label for="rating-4" class="fas fa-star"></label>
		        <input type="radio" name="rating" id="rating-3" onclick="setRate(3)">
		        <label for="rating-3" class="fas fa-star"></label>
		        <input type="radio" name="rating" id="rating-2" onclick="setRate(2)">
		        <label for="rating-2" class="fas fa-star"></label>
		        <input type="radio" name="rating" id="rating-1" onclick="setRate(1)">
		        <label for="rating-1" class="fas fa-star"></label>

		        <!-- Rating Submit Form -->
		        <form method="POST" id="review">
		        	{% csrf_token %}
		        	<input type="hidden" name="manga_id" value="{{ manga.id }}">
		        	{{ form.content }}
		            <span class="rating-reaction"></span>
		            <button type="submit" class="submit-rating align-bottom">Submit</button>
		        </form>
		    </div>
		</div>
	</div>
	<div class="container all_review">
		{% for review in manga.review_set.all %}
			<div class="card mb-3">
			  <div class="card-header">
			    {{review.user.username}}
			    {% if request.user == review.user %}
			    <button class="btn btn-danger float-end">Delete</button>
			  	{% endif %}
			  </div>
			  <div class="card-body">
			  	<span>{{ review.user.username }} gives it {{ review.given_rate }} Star{{review.given_rate|pluralize}}</span>
			    <p class="card-text">{{review.content}}</p>
			  </div>
			</div>

		{% endfor %}
	</div>
</div>
{% endblock content%}

{% block js %}

</script>

<script type="text/javascript">

	var new_option_;
	var list_number;
    var ids;
    var manga_id;
    var rate=20;

    window.list_number = {{ listitems }};
    ids = list_number;
    manga_id = {{manga.id}};
	console.log(list_number)

/*
*/
	$(function () {
	    $.ajaxSetup({
	        headers: { 'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content') }
	    });
	});

	$(".add_fav").submit(function (e) {
      // preventing from page reload and default actions
      e.preventDefault();
      // serialize the data for sending the form data.
      var serializedData = $(this).serialize();
      
      t = $(this);
      btn = t.children("button");

      // make POST ajax call
      if(btn.hasClass('btn-primary')){
      	console.log("primary")
        $.ajax({
            type: 'POST',
            url: "{% url 'add-to-fav' %}",
            data: serializedData,
            success: function (response) {
                // on successfull creating object

                t.children("button").removeClass("btn-primary");
                t.children("button").addClass("btn-danger");
                t.children("button").text("Unfollow");
                t.removeClass("add_to_fav");
                t.addClass("remove_from_fav");
            },
            error: function (response) {
                // alert the error if any error occured
                alert(response["responseJSON"]["error"]);
            }
        })
      }
      else if(btn.hasClass('btn-danger')){
      	$.ajax({
            type: 'POST',
            url: "{% url 'remove-from-fav' %}",
            data: serializedData,
            success: function (response) {
                // on successfull creating object

                t.children("button").removeClass("btn-danger");
                t.children("button").addClass("btn-primary");
                t.children("button").text("Follow");
                t.removeClass("remove_from_fav")
                t.addClass("add_to_fav")
                
            },
            error: function (response) {
                // alert the error if any error occured
                alert(response["responseJSON"]["error"]);
            }
        })
      }
  })


	$(".add_to_list").submit(function (e) {
      // preventing from page reload and default actions
      e.preventDefault();
      // serialize the data for sending the form data.
      var serializedData = $(this).serialize();
      
      t = $(this);
      btn = t.children("button");

      // make POST ajax call
      if(btn.text().trim() == '+'){
        $.ajax({
            type: 'POST',
            url: "{% url 'add-to-list' %}",
            data: serializedData,
            success: function (response) {
                // on successfull creating object

                t.children("button").text("-");
                new_ = {{ manga.id }}
                list_num = t.children("select").find(":selected").attr("class");
                window.list_number[list_num-1].push(new_)
                console.log(window.list_number)
            },
            error: function (response) {
                // alert the error if any error occured
                alert(response["responseJSON"]["error"]);
            }
        })
      }
      else if(btn.text().trim() == '-'){
      	console.log("primary")
      	$.ajax({
            type: 'POST',
            url: "{% url 'remove-from-list' %}",
            data: serializedData,
            success: function (response) {
                // on successfull creating object
                t.children("button").text("+");
                
            },
            error: function (response) {
                // alert the error if any error occured
                alert(response["responseJSON"]["error"]);
            }
        })
      }
  })


	$('#lista').change(function() {
	    list = $(this).val()
	    val = $(this).find(":selected").val()
	    if( val == 'add new list'){
	    	$('#new_option').removeClass('d-none')
	    	$('#new_option_form').removeClass('d-none')
	    	$('.container').css('opacity','0.01');

	    }
	    class_ = $(this).find(":selected").attr("class");
	    ids = list_number[class_ - 1];
	    manga_id = {{manga.id}}
	    console.log(ids);

	    if( jQuery.inArray(manga_id, ids) !== -1 ){
	    	$('#add_list_button').text('-')
	    }
	    else {
	    	$('#add_list_button').text('+')
	    }

	});

	$('#new_option_form').click(function(){
		$('#new_option').addClass('d-none')
		$('#new_option_form').addClass('d-none')
	    $('.container').css('opacity','1');
	    $('#lista option').eq(0).prop('selected', true);
	});

	function myFunction() {
	  var dots = document.getElementById("dots");
	  var moreText = document.getElementById("more");
	  var btnText = document.getElementById("myBtn");

	  if (dots.style.display === "none") {
	    dots.style.display = "inline";
	    btnText.innerHTML = "Read more";
	    moreText.style.display = "none";
	  } else {
	    dots.style.display = "none";
	    btnText.innerHTML = "Read less";
	    moreText.style.display = "inline";
	  }
	}


	$("#new_option").submit(function (e) {
		// preventing from page reload and default actions
		console.log("primary");
		e.preventDefault();
		// serialize the data for sending the form data.
		list_name = $(this).children("#new_option_input").val()
		var serializedData = $(this).serialize();

		t = $(this);
		btn = t.children("button");

		// make POST ajax call
	    $.ajax({
	        type: 'POST',
	        url: "{% url 'add-new-list' %}",
	        data: serializedData,
	        dataType: "json",
	        success: function (response) {
	            // on successfull creating object
	            $('#new_option').addClass('d-none')
				$('#new_option_form').addClass('d-none')
			    $('.container').css('opacity','1');
			    $('#lista option').eq(-1).prop('selected', true);
			    //===========
			    $('#option_add').before('<option>'+list_name+'</option>');
	        },
	        error: function (response) {
	            // alert the error if any error occured
	            alert(response["responseJSON"]["error"]);
	        }
	    })
  	})

	$("#review").submit(function(e){
		e.preventDefault();
		var serializedData = $(this).serialize() + "&rate=" + rate;
		var content = $(this).children("textarea#id_content").val();
		var username = '{{ request.user.username }}'
		console.log(serializedData);
		$.ajax({
			type: 'POST',
			url: "{% url 'submit-review' %}",
			data: serializedData,
			dataType: "json",
			success: function(response){
				reviewSubmited();
				console.log("review submited successfully");
				$(".all_review").prepend('<div class="card mb-3"><div class="card-header">'+username.toString()+'<button class="btn btn-danger float-end">Delete</button></div><div class="card-body"><span>'+username+' gives it '+rate+' Star</span><p class="card-text">'+content.toString()+'</p></div></div>');
			},

		})

	})


  	/* STAR RATE JS */
  	function reviewSubmited(){
	  	const btn = document.querySelector(".submit-rating");
		const thanksmsg = document.querySelector(".thanks-msg");
		const starRating = document.querySelector(".star-input");
		// Success msg show/hide
	    starRating.style.display = "none";
	    thanksmsg.style.display = "table";
	    return false;
  	}

  	function setRate(value_){
  		rate=value_;
  		displayRate();
  	}

  	function displayRate(){
  		console.log(rate);
  	}

{% endblock js %}